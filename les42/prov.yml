- name: Install Docker on Ubuntu using official Docker repo
  hosts: DynamicWeb 
  become: yes 
  gather_facts: false
  tasks: 
  - name: Add docker repo 
    become: yes
    shell: |
      apt-get update
      apt-get install ca-certificates curl
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      chmod a+r /etc/apt/keyrings/docker.asc
      echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
        $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
        sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      apt-get update
      exit 0
    args:
      executable: /bin/bash  

  - name: Install docker 
    become: yes    
    apt:
      name:
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-buildx-plugin
        - docker-compose-plugin
      state: present
      update_cache: yes

  - name: Add remote "vagrant" user to "docker" group
    become: yes
    user:
      name: vagrant
      group: "docker"
      append: yes

  - name: Copy project 
    copy: src=project dest=/home/vagrant owner=vagrant group=docker

  - name: reset ssh connection 
    meta: reset_connection

  - name: Run container
    shell:
      cmd: "docker compose -f compose.yml up -d"
      chdir: /home/vagrant/project
  